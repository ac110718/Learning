


WITH c_table AS
(SELECT 
  r.customer_id, 
  c.cohort,
  count(r.rental_id) AS num_rentals,
  TIMESTAMPDIFF(MONTH, c.first, r.rental_date) AS month_number
FROM rental r
  LEFT JOIN
    (SELECT 
      customer_id, 
      DATE_FORMAT(min(rental_date), '%m-%Y') AS cohort,
      min(rental_date) AS first, 
      COUNT(rental_id) AS total_rentals 
    FROM rental 
    GROUP BY customer_id) c
  ON r.customer_id = c.customer_id
GROUP BY customer_id, month_number)

SELECT
  cohort,
  COUNT(DISTINCT customer_id) AS num_customers,
  SUM(CASE WHEN month_number = 0 THEN num_rentals ELSE 0 END) AS month_0,
  SUM(CASE WHEN month_number = 1 THEN num_rentals ELSE 0 END) AS month_1,
  SUM(CASE WHEN month_number = 2 THEN num_rentals ELSE 0 END) AS month_2,
  SUM(CASE WHEN month_number = 3 THEN num_rentals ELSE 0 END) AS month_3,
  SUM(CASE WHEN month_number = 4 THEN num_rentals ELSE 0 END) AS month_4,
  SUM(CASE WHEN month_number = 5 THEN num_rentals ELSE 0 END) AS month_5,
  SUM(CASE WHEN month_number = 6 THEN num_rentals ELSE 0 END) AS month_6,
  SUM(CASE WHEN month_number = 7 THEN num_rentals ELSE 0 END) AS month_7,
  SUM(CASE WHEN month_number = 8 THEN num_rentals ELSE 0 END) AS month_8,
  SUM(CASE WHEN month_number = 9 THEN num_rentals ELSE 0 END) AS month_9
FROM c_table
GROUP BY cohort
ORDER BY cohort;




